<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>éŠæˆ²é </title>
  <style>
    /* é è¨­æ¨£å¼é‡è¨­èˆ‡èƒŒæ™¯è‰² */
    body {
      margin: 0;
      padding: 0;
      background-color: transparent;//background-color: #234c2f;
      color: white;
      //text-align: center;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-color: transparent;//rgba(0, 0, 0, 0.8);
      touch-action: none;
    }

    /* éŠæˆ²ç•«å¸ƒ */
    canvas {
      position: absolute;     /* æŠŠå…©å¼µ canvas ç–Šåœ¨å®¹å™¨è£¡ */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
    #game-canvas { z-index: 0; }
    #mask-canvas { z-index: 10; pointer-events: none; }
    #ui-canvas   { z-index: 20; pointer-events: none; }

    /* å‡ç´šé¸é …å¡ */
    #upgrade-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 1000;
    }
    .upgrade-card {
      background: rgba(0,0,0,0.85);
      border: 2px solid #fff;
      border-radius: 10px;
      padding: 15px;
      width: 200px;
      color: white;
      cursor: pointer;
      text-align: center;
      transition: transform 0.15s ease;
    }
    .upgrade-card:hover {
      transform: scale(1.05);
      border-color: yellow;
    }
    .upgrade-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .upgrade-desc {
      font-size: 14px;
    }

    /* å°è©±æ¡†æ•´é«”ä½ç½®èˆ‡æ¨£å¼ */
    #knowledge-dialog {
      position: absolute;
      z-index: 1000;
      pointer-events: auto;
    }

    #dialog-box {
      background: white;
      border: 2px solid black;
      border-radius: 10px;
      padding: 15px;
      width: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    #dialog-text {
      font-size: 16px;
      margin-bottom: 10px;
      color: black;
      text-align: center;
    }

    #dialog-continue-btn {
      padding: 6px 12px;
      background-color: #339933;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: block; /* è®“æŒ‰éˆ•è®Šæˆå€å¡Šå…ƒç´ ï¼Œæ‰èƒ½ä½¿ç”¨ margin */
      margin: 0 auto 0 auto; /* ä¸Šé–“è·20pxï¼Œè‡ªå‹•å·¦å³ç½®ä¸­ */
    }
    #dialog-continue-btn:hover { background: #63b3ed; }

    /* è™›æ“¬æ–æ¡¿å€ */
    #joystick-container {
      position: absolute;
      width: 100px;
      height: 100px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      touch-action: none;
      z-index: 20;
      display: none; /* ä¸€é–‹å§‹ä¸é¡¯ç¤º */
      align-items: center;
      justify-content: center;
      border: 2px solid #aaa;
      pointer-events: none; /* é‡è¦ï¼é¿å…æ””æˆªæ»‘å‹• */
    }

    #joystick {
      width: 40px;
      height: 40px;
      background-color: rgba(0, 255, 0, 0.5);
      border-radius: 50%;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas" width="800" height="800"></canvas>
    <canvas id="mask-canvas" width="800" height="800"></canvas> <!-- ä¸Šå±¤ç•«é»‘è‰²é®ç½© -->
    <canvas id="ui-canvas" width="800" height="800"></canvas>   <!-- UI & æ¯›æ¯›èŸ² -->

    <!-- å‡ç´šé¸é …å®¹å™¨ -->
    <div id="upgrade-container" style="display:none;">
      <div class="upgrade-card" onclick="pickUpgradeFromUI(0)">
        <div class="upgrade-name" id="upgrade-name-0"></div>
        <div class="upgrade-desc" id="upgrade-desc-0"></div>
      </div>
      <div class="upgrade-card" onclick="pickUpgradeFromUI(1)">
        <div class="upgrade-name" id="upgrade-name-1"></div>
        <div class="upgrade-desc" id="upgrade-desc-1"></div>
      </div>
      <div class="upgrade-card" onclick="pickUpgradeFromUI(2)">
        <div class="upgrade-name" id="upgrade-name-2"></div>
        <div class="upgrade-desc" id="upgrade-desc-2"></div>
      </div>
    </div>

    <!-- å°è©±æ¡†å®¹å™¨ -->
    <div id="knowledge-dialog" style="display: none;">
      <div id="dialog-box">
        <div id="dialog-text"></div>
        <button id="dialog-continue-btn">ç¹¼çºŒ</button>
      </div>
    </div>

    <!-- è™›æ“¬æ–æ¡¿ -->
    <div id="joystick-container">
      <div id="joystick"></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById("game-canvas");
    const ctx = canvas.getContext("2d");
    const maskCanvas = document.getElementById("mask-canvas");
    const maskCtx = maskCanvas.getContext("2d");
    const uiCanvas = document.getElementById("ui-canvas");
    const uiCtx = uiCanvas.getContext("2d");
    let isButterfly = false;  // é è¨­æ˜¯æ¯›æ¯›èŸ²ç‹€æ…‹ï¼Œæœ‰è¦–é‡é™åˆ¶

    let caterpillarImg = new Image();
    caterpillarImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/caterpillar.png';
    const grassImg = new Image();
    grassImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/bg.png';

    const butterflyImg = new Image();
    butterflyImg.src = "https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/butterfly.png";

    const energyBar = document.getElementById("energy-fill");
    const healthBar = document.getElementById("health-fill");
    let isUsingJoystick = false;

    const game = {
      width: canvas.width,
      height: canvas.height,
      running: true,
    };

    // ============= ä¸»è§’æ¯›æ¯›èŸ² ===============================
    const caterpillar = {
      worldX: 0, // ä»¥ä¸–ç•Œç‚ºåŸºæº–çš„åº§æ¨™
      worldY: 0,
      radius: 30,
      speed: 2,
      energy: 100,
      health: 100,     // ç•¶å‰è¡€é‡
      maxHealth: 100,  // è¡€é‡ä¸Šé™
      vx: 0,
      vy: 0,
      facingAngle: Math.PI / 2,
      level: 1,
      exp: 0,
      expToNext: 20,
      regenRate: 0,        // æ¯ç§’å›è¡€æ¯”ä¾‹ï¼ˆ0.01 = 1%ï¼‰
      hasRegen: false,
      energyGainMult: 1,   // åƒä¹³è‰å¾—åˆ°èƒ½é‡çš„å€ç‡ï¼ˆ1.0 = åŸé‡ï¼‰
      nectarSpeedMult: 1,  // å¸èŠ±èœœé€Ÿåº¦çš„å€ç‡ï¼ˆ1.0 = åŸé‡ï¼‰
      isStuck: false,      // è¢«èœ˜è››ç¶²çºä½
      damageFlashTime: 0,

      // stealth ç›¸é—œæ¬„ä½ï¼ˆæ–°å¢ï¼‰
      hasStealth: false,      // ç”±å‡ç´šå•Ÿç”¨ï¼ˆä½ çš„ apply() å·²æœƒè¨­ trueï¼‰
      isStealthed: false,     // ç•¶å‰æ˜¯å¦è™•æ–¼éš±å½¢ç‹€æ…‹
      stoppedSince: null,     // è‹¥éœæ­¢ï¼Œè¨˜éŒ„é–‹å§‹éœæ­¢çš„æ™‚é–“ï¼ˆmsï¼‰
      stealthAlpha: 0.45      // éš±å½¢æ™‚ç•«é¢é€æ˜åº¦
    };

    function drawPlayer() { // === ç•«æ¯›æ¯›èŸ² ===
      uiCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height); // æ¯æ¬¡æ¸…æ‰èˆŠçš„é®ç½©
      if (caterpillarImg.complete) {
        const size = caterpillar.radius * 2;

        // è¨ˆç®—è§’åº¦ï¼ˆä½¿ç”¨ vx å’Œ vy è¨ˆç®—ç§»å‹•æ–¹å‘ï¼‰
        const angle = Math.atan2(caterpillar.vy, caterpillar.vx); // (x, y)èˆ‡ x è»¸æ­£å‘çš„å¤¾è§’

        // æœ‰ç§»å‹•æ‰æ›´æ–°è§’åº¦
        if (caterpillar.vx !== 0 || caterpillar.vy !== 0) {
          caterpillar.facingAngle = angle;
        }

        uiCtx.save();
        uiCtx.translate(game.width / 2, game.height / 2); // å›ºå®šç•«åœ¨è¢å¹•ä¸­å¿ƒ
        uiCtx.rotate((caterpillar.facingAngle || 0) + Math.PI / 2);

        // è¨­å®šé€æ˜åº¦ï¼šè‹¥éš±å½¢å°±ä½¿ç”¨ stealthAlpha
        uiCtx.globalAlpha = caterpillar.isStealthed ? caterpillar.stealthAlpha : 1.0;

        // è¨­å®šé™°å½±ä¾†æ¨¡æ“¬å¤–æ¡†
        if (caterpillar.damageFlashTime > 0) {
          uiCtx.shadowColor = 'red';
          uiCtx.shadowBlur = 20; // æ¨¡ç³Šå€¼ï¼Œè¶Šå°æé‚Šè¶ŠéŠ³åˆ©ï¼›è¶Šå¤§è¶ŠæŸ”å’Œã€‚
        } else {
          uiCtx.shadowColor = 'black';
          uiCtx.shadowBlur = 20;
        } 
        uiCtx.shadowOffsetX = 0;
        uiCtx.shadowOffsetY = 0;

        // ç•«æ¯›æ¯›èŸ²åœ–ç‰‡ï¼ˆé™°å½±æœƒåœç¹é€æ˜éƒ¨åˆ†ï¼‰
        uiCtx.drawImage(
          caterpillarImg,
          -caterpillar.radius,
          -caterpillar.radius,
          size,
          size
        );

        // æ¢å¾© alphaï¼ˆéå¸¸é‡è¦ï¼‰
        uiCtx.globalAlpha = 1.0;

        uiCtx.restore();
      } else {
        // åœ–ç‰‡æœªè¼‰å…¥æ™‚ç”¨åœ“å½¢
        uiCtx.beginPath();
        uiCtx.arc(caterpillar.x, caterpillar.y, caterpillar.radius, 0, Math.PI * 2);
        uiCtx.fillStyle = "#00ff00";
        uiCtx.fill();
      }
    }

    const camera = { // ç›¸æ©Ÿåç§»è¨ˆç®—
      x: 0,
      y: 0
    };

    // æ¯›æ¯›èŸ²è¦–é‡è¨­å®š
    const caterpillarVision = {
      angle: Math.PI / 3, // 60 åº¦è¦–é‡
      range: 200 // è¦–é‡è·é›¢
    };

    // ç•«é»‘è‰²é®ç½©ä¸¦æŒ–å‡ºè¦–é‡
    function drawVisionMask() {
      if (isButterfly) return;  // æ˜¯è´è¶å°±ä¸ç•«é®ç½©
      maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height); // æ¯æ¬¡æ¸…æ‰èˆŠçš„é®ç½©

      // Step 1: é»‘è‰²é®ç½©
      maskCtx.fillStyle = "rgba(0, 0, 0, 0.95)";
      maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

      // Step 2: æŒ–å‡ºè¦–é‡
      maskCtx.globalCompositeOperation = "destination-out";
      maskCtx.beginPath();
      maskCtx.moveTo(game.width / 2, game.height / 2);
      maskCtx.arc(
        game.width / 2, // x ä¸­å¿ƒé»
        game.height / 2, // y ä¸­å¿ƒé»
        caterpillarVision.range, // åŠå¾‘
        caterpillar.facingAngle - caterpillarVision.angle / 2, // èµ·å§‹è§’åº¦
        caterpillar.facingAngle + caterpillarVision.angle / 2 // çµæŸè§’åº¦
      );
      maskCtx.closePath();
      maskCtx.fill();

      maskCtx.globalCompositeOperation = "source-over"; // é‚„åŸæ··åˆæ¨¡å¼
    }


    // ======================== éµç›¤æ§åˆ¶ =================================================================
    const keys = {};
    document.addEventListener("keydown", (e) => {
      keys[e.key.toLowerCase()] = true;
      isUsingJoystick = false;
    });
    document.addEventListener("keyup", (e) => {
      keys[e.key.toLowerCase()] = false;
    });
    // ---------------------ä¹³è‰-------------------------------------
    const milkweeds = [];
    const milkweedImg = new Image();
    milkweedImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/milkweed.png';
    
    let milkweedKnowledgeShown = false;
    
    function spawnMilkweed() {
      const spawnX = caterpillar.worldX + (Math.random() - 0.5) * 800;
      const spawnY = caterpillar.worldY + (Math.random() - 0.5) * 800;

      milkweeds.push({
        x: spawnX,
        y: spawnY,
        spawnTime: Date.now(),
        lifespan: 10000 // 10 ç§’å¾Œæ¶ˆå¤±
      });
    }
    function updateMilkweeds() {
      const now = Date.now();
      for (let i = milkweeds.length - 1; i >= 0; i--) {
        if (now - milkweeds[i].spawnTime > milkweeds[i].lifespan) {
          milkweeds.splice(i, 1); // ç§»é™¤éæœŸä¹³è‰
        }
      }

      if (!milkweedKnowledgeShown && !isGamePaused) {
        for (let i = 0; i < milkweeds.length; i++) {
          const mw = milkweeds[i];

          const dx = mw.x - caterpillar.worldX;
          const dy = mw.y - caterpillar.worldY;
          const dist = Math.hypot(dx, dy);

          if (dist < caterpillarVision.range) {
            // è¨ˆç®—æ¯›æ¯›èŸ²é¢å°çš„æ–¹å‘å‘é‡
            const dirX = Math.cos(caterpillar.facingAngle);
            const dirY = Math.sin(caterpillar.facingAngle);

            // è¨ˆç®—ä¹³è‰æ–¹å‘å‘é‡çš„å–®ä½å‘é‡
            const toMilkweedX = dx / dist;
            const toMilkweedY = dy / dist;

            // å…§ç©çµæœå³å…©è§’åº¦å·®ä¹‹é¤˜å¼¦å€¼
            const dot = dirX * toMilkweedX + dirY * toMilkweedY;
            const angleBetween = Math.acos(dot);

            if (angleBetween < caterpillarVision.angle / 2) {
              // âœ… åœ¨è¦–é‡ç¯„åœå…§
              showKnowledgeDialog(
                [
                  "ä¹³è‰æ˜¯æ¯›æ¯›èŸ²å”¯ä¸€çš„é£Ÿç‰©ã€‚",
                  "å°å…¶ä»–å‹•ç‰©è€Œè¨€ï¼Œä¹³è‰æ˜¯åŠ‡æ¯’çš„",
                  "å› æ­¤æ¯›æ¯›èŸ²èƒ½å¸æ”¶æ¯’ç´ è®“è‡ªèº«è®Šæ¯’ï¼Œåš‡é˜»å¤©æ•µ"
                ],
                (mw.x - camera.x > 400) ? (mw.x - camera.x - 160) : (mw.x - camera.x + 160),
                (mw.y - camera.y > 400) ? (mw.y - camera.y - 160) : (mw.y - camera.y + 160)
              );
              milkweedKnowledgeShown = true;
              isGamePaused = true;
              break;
            }
          }
        }
      }

      if (!caterpillar.isStealthed) {
        // === æª¢æŸ¥æ¯›æ¯›èŸ²èˆ‡ä¹³è‰ç¢°æ’ ===
        for (let i = milkweeds.length - 1; i >= 0; i--) {
          const dx = caterpillar.worldX - milkweeds[i].x;
          const dy = caterpillar.worldY - milkweeds[i].y;
          const dist = Math.hypot(dx, dy);

          if (dist < caterpillar.radius + 20) { // 20 æ˜¯ä¹³è‰åŠå¾‘
            // èƒ½é‡å›å¾©ï¼ˆä¸Šé™ 100ï¼‰
            const baseGain = 10;
            const gain = Math.round(baseGain * (1 + (caterpillar.energyGainMult || 0)));
            caterpillar.energy = Math.min(100, caterpillar.energy + gain);

            // ç¶“é©—å€¼å¢åŠ ï¼ˆç”¨ä½ ç¾æœ‰çš„ç³»çµ±ï¼‰
            gainExp(10); // æ¯é¡†ä¹³è‰çµ¦ 10 é»ç¶“é©—

            // ç§»é™¤ä¹³è‰
            milkweeds.splice(i, 1);
          }
        }
      }
    }
    function drawMilkweeds() {
      milkweeds.forEach(m => {
        const screenX = m.x - camera.x;
        const screenY = m.y - camera.y;
        ctx.save();

        // è¨­å®šé™°å½±ä¾†æ¨¡æ“¬å¤–æ¡†
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 20; // æ¨¡ç³Šå€¼
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        // ç¹ªè£½ä¹³è‰
        ctx.drawImage(milkweedImg, screenX - 20, screenY - 20, 40, 40);

        ctx.restore();
      });
    }
    // -------------------- èŠ±çš„è³‡æ–™ --------------------
    let flowers = [];
    let flowerSpawnInterval;
    const flowerImg = new Image();
    flowerImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/flower.png';

    const poisonFlowerImg = new Image();
    poisonFlowerImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/poisoned_flower.png';

    // å¸é£Ÿé€²åº¦
    let feedingFlower = null;
    let feedingProgress = 0;
    let feedingTime = 3000; // 3 ç§’ï¼ˆæ¯«ç§’ï¼‰

    let flowerKnowledgeShown = false;
    let poisonedflowerKnowledgeShown = false;

    // -------------------- ç”ŸæˆèŠ±ï¼ˆç¾½åŒ–å¾Œæ‰å•Ÿå‹•ï¼‰ --------------------
    function spawnFlower() {
      const spawnX = caterpillar.worldX + (Math.random() - 0.5) * 800;
      const spawnY = caterpillar.worldY + (Math.random() - 0.5) * 800;

      // 30% æ©Ÿç‡ç”Ÿæˆæ¯’èŠ±
      const isPoisonous = Math.random() < 0.2;

      flowers.push({
        x: spawnX,
        y: spawnY,
        spawnTime: Date.now(),
        lifespan: 10000, // 10 ç§’å¾Œæ¶ˆå¤±
        poisonous: isPoisonous
      });
    }

    // -------------------- æ›´æ–°èŠ±çš„å¸é£Ÿé‚è¼¯ --------------------
    function updateFlowers() {
      const now = Date.now();
      for (let i = flowers.length - 1; i >= 0; i--) {
        if (now - flowers[i].spawnTime > flowers[i].lifespan) {
          flowers.splice(i, 1); // ç§»é™¤éæœŸèŠ±
        }
      }

      if (!isGamePaused) {
        for (let i = 0; i < flowers.length; i++) {
          const f = flowers[i];

          const dx = f.x - caterpillar.worldX;
          const dy = f.y - caterpillar.worldY;
          const dist = Math.hypot(dx, dy);

          if (dist < 400) {
            if (f.poisonous && !poisonedflowerKnowledgeShown) {
              showKnowledgeDialog(
                [
                  "è¢«æ’’éè¾²è—¥çš„èŠ± (ç´«èŠ±) æ˜¯æœ‰æ¯’çš„ã€‚",
                  "äººé¡å°æ–¼è¾²åœ°çš„é–‹ç™¼ï¼Œä¹Ÿä½¿å„ç¨®å‹•ç‰©åŸå§‹æ£²åœ°å–ªå¤±ã€‚",
                  "å…¨çƒæš–åŒ–å°è‡´çš„æ°£å€™è®Šé·ä¹Ÿä½¿å¾—è´è¶é·å¾™æ›´åŠ å›°é›£ã€‚"
                ],
                (f.x - camera.x > 400) ? (f.x - camera.x - 160) : (f.x - camera.x + 160),
                (f.y - camera.y > 400) ? (f.y - camera.y - 160) : (f.y - camera.y + 160)
              );
              poisonedflowerKnowledgeShown = true;
              isGamePaused = true;
              break;
            } else if (!f.poisonous && !flowerKnowledgeShown) {
              showKnowledgeDialog(
                [
                  "èŠ±æ˜¯è´è¶çš„é£Ÿç‰©ã€‚",
                  "ä¸åŒæ–¼å¹¼èŸ²ï¼Œè´è¶ä»¥æ²æ›²å£å™¨å¸å–èŠ±èœœï¼Œ",
                  "ä¸¦åœ¨é£›è¡Œéç¨‹ä¸­ç‚ºèŠ±æœµæˆç²‰ï¼Œ",
                  "æˆç‚ºæ¤ç‰©ç¹æ®–çš„é—œéµåª’ä»‹ã€‚"
                ],
                (f.x - camera.x > 400) ? (f.x - camera.x - 160) : (f.x - camera.x + 160),
                (f.y - camera.y > 400) ? (f.y - camera.y - 160) : (f.y - camera.y + 160)
              );
              flowerKnowledgeShown = true;
              isGamePaused = true;
              break;
            }
          }
        }
      }

      if (!caterpillar.isStealthed) {
        // === æª¢æŸ¥è´è¶èˆ‡èŠ±ç¢°æ’ ===
        let isCollidingWithFlower = false;

        for (let i = 0; i < flowers.length; i++) {
          const f = flowers[i];
          const dx = caterpillar.worldX - f.x;
          const dy = caterpillar.worldY - f.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < caterpillar.radius + 20) { // åŠå¾‘ 20 çš„èŠ±
            isCollidingWithFlower = true;

            // å¦‚æœä¸æ˜¯åŒä¸€æœµèŠ±ï¼Œé‡ç½®é€²åº¦
            if (feedingFlower !== f) {
              feedingFlower = f;
              feedingProgress = 0;
            }

            feedingProgress += deltaTime;

            // å¸é£Ÿå®Œæˆ
            if (feedingProgress >= feedingTime) {
              if (f.poisonous) { // æ¯’èŠ±ï¼šæ‰£è¡€ï¼Œä¸åŠ èƒ½é‡ & ç¶“é©—
                caterpillar.health = Math.max(0, caterpillar.health - 30);
                caterpillar.damageFlashTime = 0.5;
              } else {
                // çå‹µï¼šå’Œä¹³è‰ä¸€æ¨£
                caterpillar.energy = Math.min(100, caterpillar.energy + (20 * (caterpillar.energyGainMult || 1)));
                gainExp(20 * (caterpillar.expGainMult || 1));
              }
              // ç§»é™¤èŠ±
              flowers.splice(i, 1);
              feedingFlower = null;
              feedingProgress = 0;
            }
            break;
          }
        }

        if (!isCollidingWithFlower) {
          feedingFlower = null;
          feedingProgress = 0;
        }
      }
    }

    // -------------------- ç•«èŠ± --------------------
    function drawFlowers() {
      flowers.forEach(f => {
        const screenX = f.x - camera.x;
        const screenY = f.y - camera.y;

        if (f.poisonous) {
          ctx.drawImage(poisonFlowerImg, screenX - 20, screenY - 20, 40, 40);
        } else {
          ctx.drawImage(flowerImg, screenX - 20, screenY - 20, 40, 40);
        }

        // å¦‚æœé€™æ˜¯æ­£åœ¨å¸é£Ÿçš„èŠ±ï¼Œç•«è®€æ¢
        if (f === feedingFlower) {
          const progressRatio = feedingProgress / feedingTime;
          ctx.beginPath();
          ctx.arc(screenX, screenY - 30, 15, -Math.PI / 2, -Math.PI / 2 + progressRatio * 2 * Math.PI);
          ctx.strokeStyle = "yellow";
          ctx.lineWidth = 4;
          ctx.stroke();
        }
      });
    }

    // -------------------- ç¾½åŒ–å¾Œåˆå§‹åŒ–èŠ±ç³»çµ± --------------------
    function startFlowerMode() {
      //clearInterval(milkweedSpawnInterval); // åœæ­¢ä¹³è‰ç”Ÿæˆ
      flowers = [];
      feedingFlower = null;
      feedingProgress = 0;
      //flowerSpawnInterval = setInterval(spawnFlower, 3000); // æ¯ 3 ç§’ç”Ÿæˆä¸€æœµ

      // éº»é›€é€Ÿåº¦æå‡
      const sparrowType = enemyTypes.find(t => t.id === "sparrow");
      if (sparrowType) {
        sparrowType.speed = 5;
      }
      
      scheduleEnemyActions();
    }

    let enemyActionTimer = null;

    function scheduleEnemyActions() {
      enemyActionTimer = setTimeout(() => {
        if (!isGamePaused) {
          enemies.forEach(e => {
            if (e.id === "scorpion") {
              shootScorpionProjectile(e);
            } else if (e.id === "frog") {
              shootFrogTongue(e);
            } else if (e.id === "spider") {
              createSpiderWeb(e);
            }
          });
        }
        scheduleEnemyActions(); // å†æ¬¡æ’ç¨‹
      }, 3000);
    }

    // ------------------------EXPç³»çµ±ã€ç”Ÿå‘½ã€èƒ½é‡----------------------------------------
    function gainExp(baseAmount) {
      const gain = Math.round(baseAmount * (1 + (caterpillar.expGainMult || 0)));
      caterpillar.exp += gain;
      if (caterpillar.exp >= caterpillar.expToNext) {
        caterpillar.exp -= caterpillar.expToNext;
        caterpillar.level++;
        caterpillar.expToNext = Math.floor(caterpillar.expToNext * 1.2);
        triggerLevelUpEvent();
      }
    }

    function drawPlayerBars() {
      const barWidth = 60;
      const barHeight = 6;
      const screenX = game.width / 2;
      const screenY = game.height / 2 + caterpillar.radius + 8;

      // ç”Ÿå‘½æ¢ï¼ˆç´…è‰²ï¼‰
      uiCtx.fillStyle = "#555";
      uiCtx.fillRect(screenX - barWidth / 2, screenY, barWidth, barHeight);
      uiCtx.fillStyle = "#ff4e4e";
      uiCtx.fillRect(screenX - barWidth / 2, screenY, barWidth * (caterpillar.health / caterpillar.maxHealth), barHeight);

      // èƒ½é‡æ¢ï¼ˆè—è‰²ï¼‰
      const energyY = screenY + barHeight + 4;
      uiCtx.fillStyle = "#555";
      uiCtx.fillRect(screenX - barWidth / 2, energyY, barWidth, barHeight);
      uiCtx.fillStyle = "#33cfff";
      uiCtx.fillRect(screenX - barWidth / 2, energyY, barWidth * (caterpillar.energy / 100), barHeight);
    }

    function drawExpBar() {
      const barWidth = 700;
      const barHeight = 25;
      const marginTop = 10;

      uiCtx.fillStyle = "#222";
      uiCtx.fillRect((game.width - barWidth) / 2, marginTop, barWidth, barHeight);
      uiCtx.fillStyle = "#88ff88";
      uiCtx.fillRect((game.width - barWidth) / 2, marginTop, barWidth * (caterpillar.exp / caterpillar.expToNext), barHeight);

      // ç•«ç­‰ç´šæ–‡å­—
      uiCtx.fillStyle = "white";
      uiCtx.font = "bold 30px Times New Roman";
      uiCtx.textAlign = "center";
      uiCtx.fillText(`LV. ${caterpillar.level}`, game.width / 2, marginTop + barHeight - 2);
    }
    //--------------å‡ç´š--------------------------------------
    // å‡ç´šé …ç›®è³‡æ–™ï¼ˆdesc ä½¿ç”¨ function ä»¥ä¾¿å‹•æ…‹é¡¯ç¤ºã€Œé¸å–å¾Œã€çš„æ•¸å€¼ï¼‰
    const upgrades = [
      { 
        id: "stealth", 
        name: "æ“¬æ…‹", 
        desc: () => "éœæ­¢ 3 ç§’å¾Œé€²å…¥éš±èº«ç‹€æ…‹ï¼Œç§»å‹•å¾Œå¤±æ•ˆã€‚éš±èº«æ™‚ä¸æœƒé­å—ä»»ä½•å‚·å®³",
        maxPick: 1,
        apply: () => { caterpillar.hasStealth = true; }
      },
      { 
        id: "speedUp", 
        name: "ç§»é€Ÿå¢åŠ  20%", 
        desc: () => "é€Ÿåº¦ +20%",
        maxPick: 3,
        apply: () => { caterpillar.speed *= 1.2; }
      },
      { 
        id: "visionRangeUp", 
        name: "è¦–é‡è·é›¢å¢åŠ  20%", 
        desc: () => `è¦–é‡è·é›¢ +20%`,
        maxPick: 3,
        apply: () => { caterpillarVision.range *= 1.2; }
      },
      { 
        id: "visionAngleUp", 
        name: "è¦–é‡è§’åº¦å¢åŠ  20%", 
        desc: () => `è¦–é‡è§’åº¦ +20%`,
        maxPick: 3,
        apply: () => { caterpillarVision.angle *= 1.2; }
      },
      { 
        id: "maxHpUp", 
        name: "è¡€é‡ +20", 
        desc: () => "æœ€å¤§è¡€é‡ +20 ä¸¦å›æ»¿è¡€",
        maxPick: Infinity,
        apply: () => { 
          caterpillar.maxHealth += 20; 
          caterpillar.health = caterpillar.maxHealth;
        }
      },
      { 
        id: "regen", 
        name: "è‡ªå‹•å›è¡€", 
        desc: () => {
          const cur = caterpillar.regenRate || 0;
          const future = cur + 0.01; // æ¯æ¬¡ +1%ï¼ˆ0.01ï¼‰
          return `æ¯ç§’å›å¾© ${Math.round(future * 100)}% æœ€å¤§è¡€é‡`;
        },
        maxPick: Infinity,
        apply: () => {
          caterpillar.regenRate = (caterpillar.regenRate || 0) + 0.01; // +1%/æ¬¡
          caterpillar.hasRegen = true;
        }
      },
      { 
        id: "energyGainUp", 
        name: "èƒ½é‡ç²å– +20%", 
        desc: () => "åƒä¹³è‰/èŠ±ç²å¾—çš„èƒ½é‡å¢åŠ  20%",
        maxPick: Infinity,
        apply: () => { caterpillar.energyGainMult = (caterpillar.energyGainMult || 1) + 0.2; }
      },
      {
        id: "expGainUp",
        name: "ç¶“é©—å€¼ç²å– +20%",
        desc: () => "ç²å¾—çš„ç¶“é©—å€¼å¢åŠ  20%",
        maxPick: Infinity,
        apply: () => {
          caterpillar.expGainMult = (caterpillar.expGainMult || 0) + 0.2;
        }
      },
      { 
        id: "metamorph", 
        name: "ç¾½åŒ–ç¥ç¦", 
        desc: () => "çµè›¹è›»è®Šæˆè´è¶", 
        maxPick: 1,
        onlyLevel: 8,
        apply: () => {
          // è®Šèº«ç‚ºè´è¶
          caterpillarImg = butterflyImg;
          showKnowledgeDialog(
            [
              "æ¯›æ¯›èŸ²çµæˆè›¹ï¼Œç¶“æ­·çµ„ç¹”æ¶²åŒ–èˆ‡ç´°èƒé‡çµ„ã€‚",
              "ç´„å…«å¤©å¾Œç ´è›¹è€Œå‡ºï¼Œè®Šæˆè´è¶ã€‚",
              "è´è¶çš„è¤‡çœ¼ä½¿è¦–é‡å¯é” 360 åº¦ï¼Œå…·é«˜åº¦è¡Œå‹•åŠ›ã€‚",
              "é€é 8 å­—å½¢é£›è¡Œï¼Œæ•æ·èº²é¿å¤©æ•µã€‚"
            ],
            150, 200, // å°è©±æ¡†ä½ç½®
            () => {
              caterpillar.isButterfly = true;
            }
          );
          startFlowerMode();
          caterpillar.speed = Math.max(2 * caterpillar.speed, 6); // æå‡é€Ÿåº¦è‡³è‡³å°‘ 8

          // åˆªé™¤è¦–é‡è·é›¢ã€è¦–é‡è§’åº¦
          for (let i = upgrades.length - 1; i >= 0; i--) {
            if (["visionRangeUp", "visionAngleUp"].includes(upgrades[i].id)) {
              upgrades.splice(i, 1);
            }
          }

          // åŠ å…¥è´è¶å°ˆå±¬å‡ç´š
          upgrades.push({
            id: "nectarSpeedUp",
            name: "é€²é£Ÿæ™‚é–“æ¸›å°‘ 20%",
            desc: () => {
              const cur = caterpillar.nectarSpeedMult || 1;
              const future = cur * 1.2;
              return `å¸é£ŸèŠ±èœœæ™‚é–“æ¸›å°‘ 20% (ä¹˜ç®—)`;
            },
            maxPick: Infinity,
            apply: () => {
              caterpillar.nectarSpeedMult = (caterpillar.nectarSpeedMult || 1) * 0.8;
              feedingTime *= caterpillar.nectarSpeedMult;
            }
          });
        }
      }
    ];

    // è¨˜éŒ„å‡ç´šé …ç›®å·²é¸æ¬¡æ•¸
    const upgradePickCount = {};

    // å‡ç´šè§¸ç™¼
    function triggerLevelUpEvent() {
      if (caterpillar.level === 8) {
        const blessing = upgrades.find(u => u.id === "metamorph");
        if (blessing) {
          showUpgradeChoices([blessing]); // åªé¡¯ç¤ºç¾½åŒ–ç¥ç¦
          return; // çµæŸå‡½å¼
        }
      }

      const available = upgrades.filter(u => {
        const count = upgradePickCount[u.id] || 0;
        if (count >= u.maxPick) return false;
        if (u.onlyLevel && u.onlyLevel !== caterpillar.level) return false;
        return true;
      });

      // éš¨æ©ŸæŒ‘ 3 å€‹ï¼ˆå¦‚æœä¸è¶³ 3 å€‹å°±å…¨çµ¦ï¼‰
      const choices = [];
      while (choices.length < 3 && available.length > 0) {
        const idx = Math.floor(Math.random() * available.length);
        choices.push(available.splice(idx, 1)[0]);
      }

      showUpgradeChoices(choices);
    }

    // å¥—ç”¨å‡ç´šæ•ˆæœ
    function pickUpgrade(upgrade) {
      upgrade.apply();
      upgradePickCount[upgrade.id] = (upgradePickCount[upgrade.id] || 0) + 1;
    }
    
    let currentUpgradeChoices = [];
    let isGamePaused = false;

    function showUpgradeChoices(choices) {
      isGamePaused = true; // æš«åœéŠæˆ²
      currentUpgradeChoices = choices;

      // é¡¯ç¤ºå¡ç‰‡èˆ‡å‹•æ…‹æè¿°
      choices.forEach((u, i) => {
        document.getElementById(`upgrade-name-${i}`).textContent = u.name;
        const descText = (typeof u.desc === 'function') ? u.desc() : u.desc;
        document.getElementById(`upgrade-desc-${i}`).textContent = descText;
        document.querySelectorAll(".upgrade-card")[i].style.display = "block";
      });

      // å¦‚æœä¸è¶³3å€‹ï¼Œéš±è—æ²’ç”¨åˆ°çš„å¡
      for (let i = choices.length; i < 3; i++) {
        document.getElementById(`upgrade-name-${i}`).textContent = "";
        document.getElementById(`upgrade-desc-${i}`).textContent = "";
        document.querySelectorAll(".upgrade-card")[i].style.display = "none";
      }

      // é¡¯ç¤ºå®¹å™¨
      document.getElementById("upgrade-container").style.display = "flex";
    }

    function pickUpgradeFromUI(index) {
      const upgrade = currentUpgradeChoices[index];
      if (upgrade) {
        pickUpgrade(upgrade);
      }

      // é—œé–‰ UI
      document.getElementById("upgrade-container").style.display = "none";
      isGamePaused = false; // æ¢å¾©éŠæˆ²
    }
    //--------------æ“¬æ…‹----------------------------
    function enterStealth() {
      if (!caterpillar.hasStealth) return;
      caterpillar.isStealthed = true;
    }

    function exitStealth() {
      if (!caterpillar.isStealthed) return;
      caterpillar.isStealthed = false;
      // é‡è¨­åœæ­¢è¨ˆæ™‚ï¼Œé¿å…ç«‹åˆ»å†é€²å…¥
      caterpillar.stoppedSince = null;
    }

    // -------------------- å¤©æ•µåœ–ç‰‡ --------------------
    const spiderImg = new Image();
    spiderImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/spider.png';

    const scorpionImg = new Image();
    scorpionImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/scorpion.png';

    const sparrowImg = new Image();
    sparrowImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/sparrow.png';

    const frogImg = new Image();
    frogImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/frog.png';

    // -------------------- å¤©æ•µè³‡æ–™è¡¨ --------------------
    const enemyTypes = [
      {
        id: "spider",
        img: (() => { let i = new Image(); i.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/spider.png'; return i; })(),
        speed: 1.5,
        scale: 0.1,
        rotateWithMovement: true,
        extraAngle: 0,
        spawnAsCaterpillar: true
      },
      {
        id: "scorpion",
        img: (() => { let i = new Image(); i.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/scorpion.png'; return i; })(),
        speed: 1.2,
        scale: 0.1,
        rotateWithMovement: true,
        extraAngle: Math.PI, // 180 åº¦
        spawnAsCaterpillar: true
      },
      {
        id: "sparrow",
        img: (() => { let i = new Image(); i.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/sparrow.png'; return i; })(),
        speed: 2.5,
        scale: 3 * 0.1,
        rotateWithMovement: false,
        extraAngle: 0,
        spawnAsCaterpillar: true
      },
      {
        id: "frog",
        img: (() => { let i = new Image(); i.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/frog.png'; return i; })(),
        speed: 1.8,
        scale: 3 * 0.1,
        rotateWithMovement: true,
        extraAngle: Math.PI,
        spawnAsCaterpillar: false
      }
    ];

    // -------------------- å¤©æ•µç³»çµ± --------------------
    let enemies = [];
    const enemySpawnInterval = 3000; // æ¯ 3 ç§’å˜—è©¦ç”Ÿæˆ
    const enemyLifetime = 10000; // å­˜åœ¨ 10 ç§’
    const enemySafeRadius = 200; // èˆ‡ç©å®¶è·é›¢ < 200px ä¸ç”Ÿæˆ

    let enemyKnowledgeShown = false;

    let scorpionProjectiles = []; // è å­æ¯’é‡
    let frogTongues = []; // å­˜æ”¾æ‰€æœ‰é’è›™èˆŒé ­
    const webImg = new Image();
    webImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/web.png';
    let spiderWebs = []; // æ‰€æœ‰èœ˜è››ç¶²


    function spawnEnemy() {
      const availableTypes = enemyTypes.filter(t => 
        caterpillar.isButterfly ? true : t.spawnAsCaterpillar
      );
      if (availableTypes.length === 0) return;

      const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];

      let spawnX, spawnY, dist;
      do {
        spawnX = caterpillar.worldX + (Math.random() - 0.5) * 1200;
        spawnY = caterpillar.worldY + (Math.random() - 0.5) * 1200;
        dist = Math.sqrt((spawnX - caterpillar.worldX) ** 2 + (spawnY - caterpillar.worldY) ** 2);
      } while (dist < enemySafeRadius);

      enemies.push({
        type: type, // å­˜æ•´å€‹ enemyType ç‰©ä»¶
        id: type.id,    // åŠ é€™è¡Œï¼Œä¾‹å¦‚ "scorpion"
        x: spawnX,
        y: spawnY,
        speed: type.speed,
        spawnTime: Date.now(),
        dirX: Math.random() * 2 - 1,
        dirY: Math.random() * 2 - 1
      });
    }


    function updateEnemies() {
      const now = Date.now();

      if (!enemyKnowledgeShown && !isGamePaused) {
        for (let i = 0; i < enemies.length; i++) {
          const e = enemies[i];

          const dx = e.x - caterpillar.worldX;
          const dy = e.y - caterpillar.worldY;
          const dist = Math.hypot(dx, dy);

          if (dist < caterpillarVision.range) {
            // è¨ˆç®—æ¯›æ¯›èŸ²é¢å°çš„æ–¹å‘å‘é‡
            const dirX = Math.cos(caterpillar.facingAngle);
            const dirY = Math.sin(caterpillar.facingAngle);

            // è¨ˆç®—ä¹³è‰æ–¹å‘å‘é‡çš„å–®ä½å‘é‡
            const toEnemyX = dx / dist;
            const toEnemyY = dy / dist;

            // å…§ç©çµæœå³å…©è§’åº¦å·®ä¹‹é¤˜å¼¦å€¼
            const dot = dirX * toEnemyX + dirY * toEnemyY;
            const angleBetween = Math.acos(dot);

            if (angleBetween < caterpillarVision.angle / 2) {
              // âœ… åœ¨è¦–é‡ç¯„åœå…§
              showKnowledgeDialog(
                [
                  "é é›¢å„ç¨®å¤©æ•µï¼",
                  "åœ¨ä½ è®Šæˆè´è¶å¾Œå®ƒå€‘æœƒæ›´åŠ å…‡çŒ›ã€‚",
                  "è­¬å¦‚ï¼šè å­æœƒå°„å‡ºæ¯’é‡ (ç´…è‰²ä¸‰è§’å½¢)ã€‚"
                ],
                (e.x - camera.x > 400) ? (e.x - camera.x - 160) : (e.x - camera.x + 160),
                (e.y - camera.y > 400) ? (e.y - camera.y - 160) : (e.y - camera.y + 160)
              );
              enemyKnowledgeShown = true;
              isGamePaused = true;
              break;
            }
          }
        }
      }
      
      for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];

        // å¶çˆ¾æ”¹è®Šæ–¹å‘ï¼ˆæ¯ç§’å¤§ç´„ 1% æ©Ÿç‡ï¼‰
        if (
          e.id !== "spider" ||        // å¦‚æœä¸æ˜¯èœ˜è››ï¼Œç…§æ¨£äº‚è·‘
          !e.isChasingPlayer           // æ˜¯èœ˜è››ä½†æ²’åœ¨è¿½äººï¼Œä¹Ÿç…§æ¨£äº‚è·‘
        ) {
          if (Math.random() < 0.01) {
            e.dirX = Math.random() * 2 - 1;
            e.dirY = Math.random() * 2 - 1;
            const len = Math.sqrt(e.dirX * e.dirX + e.dirY * e.dirY);
            e.dirX /= len;
            e.dirY /= len;
          }
        }

        // ç§»å‹•
        e.x += e.dirX * e.speed;
        e.y += e.dirY * e.speed;

        // æ™‚é–“åˆ° -> æ¶ˆå¤±
        if (now - e.spawnTime >= enemyLifetime) {
          enemies.splice(i, 1);
          continue;
        }

        // å¤©æ•µç¢°æ’æª¢æŸ¥ï¼ˆéš±å½¢æ™‚ä¸æª¢æŸ¥ï¼‰
        if (!caterpillar.isStealthed) {
          const dx = caterpillar.worldX - e.x;
          const dy = caterpillar.worldY - e.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < caterpillar.radius + 20) {
            caterpillar.health -= 30;
            caterpillar.damageFlashTime = 0.5;
            if (caterpillar.health < 0) caterpillar.health = 0;
            enemies.splice(i, 1);
          }
        }
      }
    }

    function drawEnemies() {
      enemies.forEach(e => {
        const screenX = e.x - camera.x;
        const screenY = e.y - camera.y;
        const type = e.type;

        ctx.save();
        ctx.translate(screenX, screenY);

        if (type.rotateWithMovement) {
          let angle = Math.atan2(e.dirY, e.dirX) + Math.PI / 2 + type.extraAngle;
          ctx.rotate(angle);
        } else {
          ctx.rotate(type.extraAngle);
        }

        const drawW = type.img.width * type.scale;
        const drawH = type.img.height * type.scale;

        // è¨­å®šé™°å½±ä¾†æ¨¡æ“¬å¤–æ¡†
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 20; // æ¨¡ç³Šå€¼
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        ctx.drawImage(type.img, -drawW / 2, -drawH / 2, drawW, drawH);
        ctx.restore();
      });
    }

    // --------è å­æ¯’é‡ç›¸é—œ---------------------------------
    function shootScorpionProjectile(enemy) {
      const angle = Math.atan2(enemy.dirY, enemy.dirX); // ç”¨ç•¶å‰ç§»å‹•æ–¹å‘
      scorpionProjectiles.push({
        x: enemy.x,
        y: enemy.y,
        dirX: Math.cos(angle),
        dirY: Math.sin(angle),
        angle: angle,
        speed: 2,
        spawnTime: Date.now(),
        lifespan: 10000
      });
    }
    
    function updateScorpionProjectiles() {
      const now = Date.now();
      for (let i = scorpionProjectiles.length - 1; i >= 0; i--) {
        const p = scorpionProjectiles[i];

        // é£›è¡Œ
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed;

        // è¶…æ™‚æ¶ˆå¤±
        if (now - p.spawnTime > p.lifespan) {
          scorpionProjectiles.splice(i, 1);
          continue;
        }

        // ç¢°æ’æª¢æŸ¥
        if (!caterpillar.isStealthed) {
          const dx = caterpillar.worldX - p.x;
          const dy = caterpillar.worldY - p.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < caterpillar.radius) {
            caterpillar.health -= 30;
            caterpillar.damageFlashTime = 0.5;
            scorpionProjectiles.splice(i, 1); // æå‰æ¶ˆå¤±
          }
        }
      }
    }

    function drawScorpionProjectiles() {
      scorpionProjectiles.forEach(p => {
        const screenX = p.x - camera.x;
        const screenY = p.y - camera.y;

        ctx.save();
        ctx.translate(screenX, screenY);
        ctx.rotate(p.angle);
        ctx.scale(7, 7); // æ”¾å¤§ 7 å€

        // æ¯’é‡å¤–è§€ï¼šçŸ­ç·šæ®µ
        ctx.beginPath();
        ctx.moveTo(0, -2);
        ctx.lineTo(10, 0);
        ctx.lineTo(0, 2);
        ctx.closePath();
        ctx.fillStyle = "red";
        ctx.fill();

        ctx.restore();
      });
    }
    //--------------é’è›™èˆŒé ­ç›¸é—œ-------------------------------
    function shootFrogTongue(frog) {
      const angle = Math.atan2(frog.dirY, frog.dirX); // ä¾ç§»å‹•æ–¹å‘æ±ºå®šè§’åº¦
      frogTongues.push({
        frog: frog,
        angle: angle,
        length: 150, // èˆŒé ­é•·åº¦
        spawnTime: Date.now(),
        duration: 500 // å­˜æ´» 500ms
      });
    }


    function updateFrogTongues() {
      const now = Date.now();
      frogTongues = frogTongues.filter(t => now - t.spawnTime < t.duration);

      frogTongues.forEach(t => {
        const progress = (now - t.spawnTime) / t.duration;
        const length = t.length * (progress <= 0.5 ? progress * 2 : (1 - progress) * 2); // 0~1~0
        // èˆŒé ­å°–ç«¯ä½ç½®
        const tipX = t.frog.x + Math.cos(t.angle) * length;
        const tipY = t.frog.y + Math.sin(t.angle) * length;

        // éš±å½¢æ™‚å®Œå…¨ä¸æª¢æ¸¬ç¢°æ’
        if (!caterpillar.isStealthed) {
          const dx = caterpillar.worldX - tipX;
          const dy = caterpillar.worldY - tipY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < caterpillar.radius) {
            caterpillar.health = Math.max(0, caterpillar.health - 30);
            caterpillar.damageFlashTime = 0.5;
            t.spawnTime = 0; // è®“èˆŒé ­ç«‹å³æ¶ˆå¤±
          }
        }
      });
    }

    function drawFrogTongues() {
      const now = Date.now();
      frogTongues.forEach(t => {
        // æš«åœæ™‚ï¼Œå‡çµå‹•ç•«é€²åº¦ï¼ˆé¡¯ç¤ºæ™‚é•·ä¸è®Šï¼‰
        const effectiveNow = isGamePaused ? t.spawnTime : now;
        const progress = (effectiveNow - t.spawnTime) / t.duration;
        const length = t.length * (progress <= 0.5 ? progress * 2 : (1 - progress) * 2);

        const startX = t.frog.x - camera.x;
        const startY = t.frog.y - camera.y;
        const endX = startX + Math.cos(t.angle) * length;
        const endY = startY + Math.sin(t.angle) * length;

        ctx.strokeStyle = "pink";
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      });
    }
    //--------------èœ˜è››ç¶²ç›¸é—œ-----------------------------------
    function createSpiderWeb(spider) {
      spiderWebs.push({
        x: spider.x,
        y: spider.y,
        spawnTime: Date.now(),
        duration: 10000, // æœ€å¤šå­˜åœ¨ 10 ç§’
        radius: 40,       // ç¢°æ’åˆ¤å®šç”¨
        creator: spider   // â¬…ï¸ è¨˜éŒ„æ˜¯å“ªä¸€éš»èœ˜è››ç”¢ç”Ÿé€™å¼µç¶²
      });
    }

    function updateSpiderWebs() {
      const now = Date.now();

      // â¬…ï¸ å¦‚æœå¡ä½çµæŸæ™‚é–“åˆ°äº†ï¼Œè§£é™¤å¡ä½ç‹€æ…‹ï¼Œä¸¦ç§»é™¤å°æ‡‰çš„èœ˜è››ç¶²
      if (caterpillar.isStuck && now >= caterpillar.stuckUntil) {
        caterpillar.isStuck = false;

        if (caterpillar.stuckWeb) {
          // æŠŠé‚£å€‹ç‰¹å®šèœ˜è››ç¶²å¾é™£åˆ—ä¸­ç§»é™¤
          const index = spiderWebs.indexOf(caterpillar.stuckWeb);
          if (index !== -1) spiderWebs.splice(index, 1);
          caterpillar.stuckWeb = null;
        }
      }

      // â¬…ï¸ æ­£å¸¸ç§»é™¤å·²éæ™‚çš„èœ˜è››ç¶²ï¼ˆä¸æœƒç§»é™¤è¢«ç¢°åˆ°çš„ï¼‰
      spiderWebs = spiderWebs.filter(web => {
        // å¦‚æœæ˜¯æ­£åœ¨ç¶ä½è´è¶çš„é‚£å¼µï¼Œå°±å…ˆä¿ç•™
        if (web === caterpillar.stuckWeb) return true;
        return now - web.spawnTime < web.duration;
      });

      // â¬…ï¸ åªæœ‰æ²’è¢«å¡ä½æ™‚æ‰æª¢æŸ¥æ˜¯å¦ç¢°åˆ°èœ˜è››ç¶²
      if (!caterpillar.isStuck) {
        spiderWebs.forEach(web => {
          const dx = caterpillar.worldX - web.x;
          const dy = caterpillar.worldY - web.y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < caterpillar.radius + web.radius) {
            caterpillar.isStuck = true;
            caterpillar.stuckUntil = now + 3000; // å¡ä½ 3 ç§’
            caterpillar.stuckWeb = web; // è¨˜éŒ„æ˜¯å“ªå¼µç¶²é»ä½ä»–

            // è®“è©²èœ˜è››è¿½éä¾†
            if (web.creator && enemies.includes(web.creator) && web.creator.id === "spider") {
              const e = web.creator;
              const len = Math.hypot(caterpillar.worldX - e.x, caterpillar.worldY - e.y);
              if (len > 0) {
                e.dirX = (caterpillar.worldX - e.x) / len;
                e.dirY = (caterpillar.worldY - e.y) / len;
              }
              e.speed = 3; // åŠ é€Ÿè¿½æ“Š
            }
          }
        });
      }
    }

    function drawSpiderWebs() {
      spiderWebs.forEach(web => {
        const screenX = web.x - camera.x;
        const screenY = web.y - camera.y;
        const drawW = webImg.width * 0.2;
        const drawH = webImg.height * 0.2;

        ctx.save();
        ctx.translate(screenX, screenY);

        if (web === caterpillar.stuckWeb) {
          // è¦–è¦ºæç¤ºï¼šç´…è‰²æ¿¾å…‰æ•ˆæœ
          ctx.globalAlpha = 1;
          ctx.filter = "drop-shadow(0 0 10px red)";
        } else {
          ctx.globalAlpha = 0.6;
          ctx.filter = "none";
        }

        ctx.drawImage(webImg, -drawW / 2, -drawH / 2, drawW, drawH);
        ctx.restore();
      });
    }
    //--------------å‡çµã€å‡ºç¾æ£®æ—------------------------------------------
    let southMode = false;
    let freezeStartTime = null;
    let freezeSpeed = 1; // æ¯æ¯«ç§’å¾€ä¸‹ç§»å‹•çš„è·é›¢
    let freezeLineY = null;
    let forestY = null;
    const forestX = 0;

    const forestImg = new Image();
    forestImg.src = 'https://raw.githubusercontent.com/tam004team/Butterfly_Journey/main/images/forest.png';

    function checkSouthMigrationTrigger() {
      if (!southMode && caterpillar.level >= 12) {
        southMode = true;
        freezeStartTime = Date.now();
        freezeLineY = caterpillar.worldY - 300; // åˆå§‹å‡çµç·šç¨å¾®åœ¨ä¸Šæ–¹
        forestY = caterpillar.worldY + 4000;    // æ£®æ—ä½ç½®

        showKnowledgeDialog(
          [
            "ç‚ºäº†èº²é¿åš´å¯’ï¼Œä½ å¿…é ˆä¸€è·¯å‘å—ã€‚"
          ],
          100, freezeLineY - camera.y,
          () => {
            showKnowledgeDialog(
              [
                "è´è¶å¦‚ä½•çŸ¥é“è‡ªå·±è¦é£›å¾€å“ªè£¡ï¼Ÿ",
                "é€™ä¾èˆŠæ˜¯å€‹è¬ã€‚",
                "è´è¶è§¸é¬šæœ‰è¿½è¹¤å¤ªé™½ä½ç½®çš„æ©Ÿåˆ¶ã€‚",
                "é‚„èƒ½æ„ŸçŸ¥æ°£æµã€å€ŸåŠ©å¾®é¢¨çœåŠ›å‰é€²ã€‚",
                "æ²¿è‘—å³ä¸Šè§’æŒ‡æ¨™é£›è¡Œï¼Œæ‰¾åˆ°æœ€çµ‚çš„ç›®çš„åœ°ï¼"
              ],
              700, 200,
            );
          }
        );
        isGamePaused = true;
      }
    }

    //-------å‡çµé‚Šç•Œæ›´æ–°èˆ‡ç¢°æ’åˆ¤å®š-----------
    function updateFreezingZone() {
      if (!southMode) return;

      //const elapsed = Date.now() - freezeStartTime;
      freezeLineY += freezeSpeed ;
      //freezeStartTime = Date.now(); // é‡è¨­èµ·é»ä»¥é¿å…ç´¯åŠ éå¤§

      if (caterpillar.worldY < freezeLineY) {
        gameOver(); // ç©å®¶å¤ªåŒ—é‚Š
      }
    }

    //-------æ£®æ—åˆ°é”æª¢æŸ¥èˆ‡è·³é ----------
    function checkForestArrival() {
      if (!southMode) return;
      const dx = forestX - caterpillar.worldX;
      const dy = forestY - caterpillar.worldY;
      const dist = Math.hypot(dx, dy);
      if (dist < 150) { // åˆ°é”ç¯„åœ
        localStorage.setItem('gameTime', gameTime);
        window.location.href = "https://tam004team.github.io/Butterfly_Journey/ending.html";
      }
    }

    //------ç•«æ£®æ—---------------------------
    function drawForestTarget() {
      if (!southMode || !forestImg.complete) return;

      const screenX = forestX - camera.x
      const screenY = forestY - camera.y;

      const drawW = forestImg.width * 0.3;
      const drawH = forestImg.height * 0.3;

      ctx.save();
      ctx.translate(screenX, screenY);

      // ğŸŒŸ ç™¼å…‰æ•ˆæœï¼ˆç°¡å–®å…‰æšˆï¼‰
      const pulse = 0.5 + 0.5 * Math.sin(Date.now() / 300); // é–ƒçˆå› å­
      ctx.shadowColor = `rgba(255, 255, 0, ${0.4 + 0.4 * pulse})`;
      ctx.shadowBlur = 100;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;

      ctx.drawImage(forestImg, -drawW / 2, -drawH / 2, drawW, drawH);
      ctx.restore();
    }

    //------æŒ‡å—é‡ç®­é ­èˆ‡è·é›¢æç¤º--------
    function drawForestCompass() {
      if (!southMode) return;

      const dx = forestX - caterpillar.worldX;
      const dy = forestY - caterpillar.worldY;
      const dist = Math.hypot(dx, dy);
      const angle = Math.atan2(dy, dx) + Math.PI / 2;

      const centerX = canvas.width - 120;
      const centerY = 120;

      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(angle);
      
      // ç•«ç®­é ­
      ctx.beginPath();
      ctx.moveTo(0, -20);
      ctx.lineTo(12, 20);
      ctx.lineTo(-12, 20);
      ctx.closePath();
      ctx.fillStyle = "yellow";
      ctx.fill();

      ctx.restore();

      // é¡¯ç¤ºå‰©é¤˜å…¬é‡Œæ•¸
      const kmLeft = dist.toFixed(1);
      ctx.font = "32px Arial";
      ctx.fillStyle = "white";
      ctx.fillText(`${kmLeft} km`, centerX - 60, centerY + 60);
    }

    //-----å‡çµå€è¦–è¦ºæ•ˆæœ-------------
    function drawFreezingZone() {
      if (!southMode) return;

      const screenY = freezeLineY - camera.y;

      ctx.fillStyle = "rgba(150, 220, 255, 0.4)";
      ctx.fillRect(0, 0, canvas.width, screenY);
    }

    //--------------æ›´æ–°ç•«é¢-----------------------------------
    let gameTime = 0;

    let lastUpdateTime = Date.now();
    let dt = 0;
    function update() {
      const now = Date.now();
      if (isGamePaused) {
        lastUpdateTime = now;
      }
      if (!isGamePaused) {
        dt = (now - lastUpdateTime) / 1000;
        gameTime += dt;
      }
      if (isGamePaused) return; // æš«åœæ™‚ä¸æ›´æ–°éŠæˆ²é‚è¼¯

      checkSouthMigrationTrigger();

      if (!isUsingJoystick) {
        if (caterpillar.isStuck) {
          caterpillar.vx = 0;
          caterpillar.vy = 0;
        } else {
          // éµç›¤æ§åˆ¶æ™‚ï¼Œé‡è¨­é€Ÿåº¦
          caterpillar.vx = 0;
          caterpillar.vy = 0;

          if (keys["w"]) caterpillar.vy -= 1;
          if (keys["s"]) caterpillar.vy += 1;
          if (keys["a"]) caterpillar.vx -= 1;
          if (keys["d"]) caterpillar.vx += 1;

          // ç”¨ç•«å¸ƒçš„æ¯”ä¾‹ä¾†ä¿®æ­£
          const scaleY = canvas.width / canvas.height;
          let len = Math.hypot(caterpillar.vx, caterpillar.vy * scaleY);
          if (len > 0) {
            caterpillar.vx = (caterpillar.vx / len) * caterpillar.speed;
            caterpillar.vy = (caterpillar.vy / len) * caterpillar.speed;
            caterpillar.facingAngle = Math.atan2(caterpillar.vy, caterpillar.vx);
          }
        }
      }
      // ---------- æª¢æŸ¥æ˜¯å¦é–‹å§‹æˆ–çµæŸéš±å½¢ ----------
      if (caterpillar.hasStealth && !caterpillar.isStuck) { // å¦‚æœç©å®¶æœ‰æ“¬æ…‹èƒ½åŠ›ä¸”æ²’è¢«èœ˜è››ç¶²çºä½
        if (caterpillar.vx === 0 && caterpillar.vy === 0) { // å¦‚æœç¾åœ¨å®Œå…¨æ²’ç§»å‹•
          if (caterpillar.stoppedSince === null) {
            // å‰›é–‹å§‹éœæ­¢ï¼Œè¨˜éŒ„æ™‚é–“
            caterpillar.stoppedSince = Date.now();
          } else {
            // å·²ç¶“éœæ­¢ä¸€æ®µæ™‚é–“ï¼Œæª¢æŸ¥æ˜¯å¦é”åˆ° 3000ms
            if (!caterpillar.isStealthed && (Date.now() - caterpillar.stoppedSince >= 3000)) {
              enterStealth();
            }
          }
        } else {
          // æœ‰ç§»å‹• -> ç«‹å³é€€å‡ºéš±å½¢ï¼ˆå¦‚æœä¹‹å‰åœ¨éš±å½¢ï¼‰
          if (caterpillar.isStealthed) exitStealth();
          // ä¹Ÿé‡è¨­åœæ­¢è¨ˆæ™‚
          caterpillar.stoppedSince = null;
        }
      }
      if (!caterpillar.isButterfly) {
        updateMilkweeds();
      } else {
        updateFlowers();
      }

      updateFreezingZone();
      
      updateEnemies();
      updateScorpionProjectiles();
      updateFrogTongues();
      updateSpiderWebs();

      checkForestArrival();

      if (caterpillar.isStuck) {
        if (Date.now() >= caterpillar.stuckUntil) {
          caterpillar.isStuck = false; // è§£é–‹
        } else {
          return; // æå‰ä¸­æ–·ç§»å‹•é‚è¼¯
        }
      }

      if (caterpillar.damageFlashTime > 0) {
        caterpillar.damageFlashTime -= 0.001 * deltaTime;
        if (caterpillar.damageFlashTime < 0) {
          caterpillar.damageFlashTime = 0;
        }
      }

      // ä½ç½®æ›´æ–°ï¼ˆç„¡è«–æ˜¯å“ªå€‹æ§åˆ¶æ–¹å¼ï¼‰
      caterpillar.worldX += caterpillar.vx;
      caterpillar.worldY += caterpillar.vy;

      // è®“ç›¸æ©Ÿä¸­å¿ƒå°æº–è§’è‰²
      camera.x = caterpillar.worldX - game.width / 2;
      camera.y = caterpillar.worldY - game.height / 2;
    }
    

    function draw() {
      // æ¸…é™¤ç•«é¢
      ctx.clearRect(0, 0, game.width, game.height);
      maskCtx.clearRect(0, 0, game.width, game.height);

      drawBackground();
      drawFreezingZone();

      if (!caterpillar.isButterfly){
        drawMilkweeds();
      } else {
        drawFlowers();
      }
      drawEnemies();
      drawScorpionProjectiles();
      drawFrogTongues();
      drawSpiderWebs();

      drawForestCompass();
      drawForestTarget();

      // å…ˆç•«åœ°åœ–èˆ‡ç‰©ä»¶ï¼Œå†ç•«é»‘è‰²é®ç½©
      if (!caterpillar.isButterfly) {
        drawVisionMask(); // åŸæœ¬æ¯›æ¯›èŸ²çš„é»‘è‰²é®ç½©
      }
      // å†ç•«æ¯›æ¯›èŸ²ã€ç¶“é©—æ¢ï¼Œç¢ºä¿å®ƒæ°¸é å¯è¦‹
      drawPlayer();
      drawPlayerBars();
      drawExpBar();
    }

    function drawBackground() {
      const pattern = ctx.createPattern(grassImg, 'repeat');
      ctx.save();
      ctx.globalAlpha = 0.8; // é€æ˜åº¦ï¼ˆ0=å®Œå…¨é€æ˜ï¼Œ1=ä¸é€æ˜ï¼‰
      ctx.translate(-camera.x % grassImg.width, -camera.y % grassImg.height);
      ctx.fillStyle = pattern;
      ctx.fillRect(-grassImg.width, -grassImg.height, game.width + grassImg.width * 2, game.height + grassImg.height * 2);
      ctx.restore();
    }

    function gameOver() {
      game.running = false;
      location.href="https://tam004team.github.io/Butterfly_Journey/fail_ending.html";
    }

    let lastTime = 0; // å‰ä¸€å¹€çš„æ™‚é–“
    let deltaTime = 0; // é€™ä¸€å¹€èˆ‡ä¸Šä¸€å¹€çš„æ™‚é–“å·®ï¼ˆå–®ä½ï¼šç§’ï¼‰
    function gameLoop(timestamp) {
      if (!game.running) return;

      deltaTime = (timestamp - lastTime);
      lastTime = timestamp;


      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // =================================== çŸ¥è­˜å…§å®¹ ==================================================================
    let currentDialogIndex = 0;
    let currentDialogPages = [];
    let onDialogEnd = null;

    function showKnowledgeDialog(pages, x, y, onFinish = null) {
      // æš«åœéŠæˆ²
      isGamePaused = true;
      
      currentDialogIndex = 0;
      currentDialogPages = pages;
      onDialogEnd = onFinish;

      const dialog = document.getElementById("knowledge-dialog");
      const textEl = document.getElementById("dialog-text");
      const btn = document.getElementById("dialog-continue-btn");

      // é¡¯ç¤ºå°è©±æ¡†
      dialog.style.display = "block";

      const rect = canvas.getBoundingClientRect();
      const scaleX = rect.width / game.width;   // X è»¸ç¸®æ”¾æ¯”ä¾‹
      const scaleY = rect.height / game.height; // Y è»¸ç¸®æ”¾æ¯”ä¾‹

      // æŠŠ canvas åº§æ¨™è½‰æˆè¢å¹•åº§æ¨™
      let screenX = rect.left + (x * scaleX); // rect.left æ˜¯ canvas å·¦ä¸Šè§’åœ¨è¢å¹•ä¸Šçš„ä½ç½®
      let screenY = rect.top + (y * scaleY);

      // è¨­å®šä½ç½®ï¼ˆå°è©±æ¡†å·¦ä¸Šè§’ä½ç½®ï¼‰
      // å–å¾—å¯¦éš›å¯¬é«˜
      const dialogWidth = dialog.offsetWidth;
      const dialogHeight = dialog.offsetHeight;
      // ä¿®æ­£ Xï¼šä¸è¶…å‡ºç•«å¸ƒ
      if (screenX + dialogWidth > rect.right) {
        screenX = rect.right - dialogWidth - 10;
      }
      if (screenX < rect.left) screenX = rect.left + 10;

      // ä¿®æ­£ Yï¼šä¸è¶…å‡ºç•«å¸ƒ
      if (screenY + dialogHeight > rect.bottom) {
        screenY = rect.bottom - dialogHeight - 10;
      }
      if (screenY < rect.top) screenY = rect.top + 10;

      // æ›´æ–°ä¿®æ­£å¾Œçš„ä½ç½®
      dialog.style.left = `${screenX}px`;
      dialog.style.top = `${screenY}px`;

      // é¡¯ç¤ºç¬¬ä¸€æ®µ
      textEl.textContent = pages[currentDialogIndex];

      btn.onclick = () => {
        currentDialogIndex++;
        if (currentDialogIndex < currentDialogPages.length) {
          // ä¸‹ä¸€é 
          textEl.textContent = currentDialogPages[currentDialogIndex];
        } else {
          // çµæŸ
          dialog.style.display = "none";
          isGamePaused = false;
          if (onDialogEnd) onDialogEnd();
        }
      };
    }

    showKnowledgeDialog(
      [
        "æ¯›æ¯›èŸ²çš„è¦–é‡æ˜¯æœ‰é™çš„ï¼Œåªæœ‰å‰æ–¹ä¸€å°å¡Šå€åŸŸå¯ä»¥çœ‹æ¸…æ¥šã€‚",
        "ä½ éœ€è¦ç§»å‹•èº«é«”æ‰èƒ½çœ‹åˆ°æ›´å¤šçš„ä¸–ç•Œã€‚",
        "å°å¿ƒå››å‘¨ï¼Œå±éšªå¯èƒ½å°±åœ¨ä½ çœ‹ä¸åˆ°çš„åœ°æ–¹ã€‚"
      ],
      150, 200, // å°è©±æ¡†ä½ç½®
      () => {
        showKnowledgeDialog(
          [
            "éœ€è¦é€éé€²é£Ÿä¾†ç²å¾—ç¶“é©—å’Œè£œå……èƒ½é‡ (è—æ¢)ã€‚",
            "èƒ½é‡è€—ç›¡ä¹‹æ—¥ï¼Œä¾¿æ˜¯è‘¬èº«ä¹‹æ™‚ã€‚",
            "æ“æœ‰è¶³å¤ ç¶“é©—ï¼Œå°±èƒ½ç¾½åŒ–æˆè¶ã€‚",
            "é–‹å§‹ä½ æ–°çš„ä¸€ç”Ÿå§ï¼"
          ],
          150, 500, // å°è©±æ¡†ä½ç½®
        );
      }
    );

    // =================================== è™›æ“¬æ–æ¡¿æ§åˆ¶ ==================================================================
    const joystickContainer = document.getElementById("joystick-container");
    const joystick = document.getElementById("joystick");
    let dragging = false;
    let joyStart = { x: 0, y: 0 };

    // é¡¯ç¤ºæ–æ¡¿ä¸¦è¨­å®šåˆå§‹ä½ç½®
    function showJoystick(x, y) {
      joystickContainer.style.display = "flex";
      joystickContainer.style.left = `${x - 50}px`; // ä¸­å¿ƒå°é½Š
      joystickContainer.style.top = `${y - 50}px`;
    }

    // éš±è—æ–æ¡¿
    function hideJoystick() {
      joystickContainer.style.display = "none";
      caterpillar.vx = 0;
      caterpillar.vy = 0;
    }

    // å°‡è¢å¹•åº§æ¨™è½‰æ›ç‚º Canvas å…§éƒ¨åº§æ¨™
    function getCanvasCoordinates(touchEvent) {
        const rect = canvas.getBoundingClientRect(); // ç²å–ç•«å¸ƒåœ¨è¢å¹•ä¸Šçš„å¯¦éš›ä½ç½®å’Œå¤§å°
        const touch = touchEvent.touches[0];

        // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        // é€²è¡Œåº§æ¨™è½‰æ›
        const canvasX = (touch.clientX - rect.left) * scaleX;
        const canvasY = (touch.clientY - rect.top) * scaleY;

        return { x: canvasX, y: canvasY };
    }

    window.addEventListener("touchstart", (e) => {
      const touch = e.touches[0];
      // è¦–è¦ºä¸Šçš„æ–æ¡¿ä¾ç„¶ä½¿ç”¨è¢å¹•åº§æ¨™ï¼Œæ‰èƒ½æ­£ç¢ºé¡¯ç¤ºåœ¨æ‰‹æŒ‡ä¸‹æ–¹
      showJoystick(touch.clientX, touch.clientY); 
      
      // ä½†æˆ‘å€‘çš„éŠæˆ²é‚è¼¯ï¼Œä½¿ç”¨è½‰æ›å¾Œçš„ç•«å¸ƒåº§æ¨™
      const coords = getCanvasCoordinates(e);
      joyStart = { x: coords.x, y: coords.y };
      dragging = true;
      isUsingJoystick = true; // ä»£è¡¨ç•¶å‰ç”±æ–æ¡¿æ§åˆ¶
    });

    window.addEventListener("touchmove", (e) => {
      if (!dragging) return;

      if (caterpillar.isStuck) {
        // è¢«èœ˜è››ç¶²çºä½ï¼Œä¸èƒ½æ§åˆ¶ç§»å‹•
        caterpillar.vx = 0;
        caterpillar.vy = 0;
        return;
      }

      // åŒæ¨£ï¼Œå°‡ç•¶å‰æ‰‹æŒ‡ä½ç½®ä¹Ÿè½‰æ›ç‚ºç•«å¸ƒåº§æ¨™
      const coords = getCanvasCoordinates(e);

      // dx å’Œ dy ç¾åœ¨æ˜¯åŸºæ–¼ 800x600 ç•«å¸ƒçš„æ­£ç¢ºå‘é‡
      const dx = coords.x - joyStart.x;
      const dy = coords.y - joyStart.y;

      const len = Math.hypot(dx, dy); // å› ç‚ºåº§æ¨™å·²ç¶“è¢«æ ¡æ­£ï¼Œä¸å†éœ€è¦æ‰‹å‹•ä¹˜ä»¥ scaleY
      if (len > 0) {
        // ç›´æ¥ç”¨ dx å’Œ dy ä¾†è¨ˆç®—é€Ÿåº¦ï¼Œlen æœƒè² è²¬å°‡å…¶æ¨™æº–åŒ–
        caterpillar.vx = 1.5 * (dx / len) * caterpillar.speed;
        caterpillar.vy = 1.5 *(dy / len) * caterpillar.speed;
      }
    });

    window.addEventListener("touchend", () => {
      dragging = false;
      hideJoystick();
      isUsingJoystick = false; // åœæ­¢ä½¿ç”¨æ–æ¡¿æ§åˆ¶
    });

    // å•Ÿå‹•éŠæˆ²
    requestAnimationFrame(gameLoop);

    // === èƒ½é‡æ¯ç§’è‡ªå‹•æ¸›å°‘ ===
    setInterval(() => {
      if (!game.running) return;
      if (isGamePaused) return; // æš«åœæ™‚æš«åœé€™äº›æ¯ç§’æ•ˆæœ

      // èƒ½é‡é€ç§’æµå¤±
      caterpillar.energy -= 1;

      // è‡ªå‹•å›è¡€ï¼ˆè‹¥æœ‰é¸ï¼‰
      if (caterpillar.hasRegen && (caterpillar.regenRate || 0) > 0) {
        caterpillar.health = Math.min(caterpillar.maxHealth, caterpillar.health + (caterpillar.maxHealth * (caterpillar.regenRate || 0)));
      }

      if (caterpillar.energy <= 0) {
        caterpillar.energy = 0;
        gameOver();
      }
      if (caterpillar.health <= 0) {
        caterpillar.health = 0;
        gameOver();
      }
    }, 1000);
    setInterval(() => {
      if (game.running && !isGamePaused) {
        if (!caterpillar.isButterfly) {
          spawnMilkweed();  
        } else {
          spawnFlower();
        }
      }
    }, 1500);
    setInterval(() => {
      if (game.running && !isGamePaused) {
        spawnEnemy();
      }
    }, enemySpawnInterval);

  </script>
</body>
</html>
